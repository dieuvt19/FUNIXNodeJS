'use strict';

module.exports = function parse(ctx, next) {
  let msg = ctx.msg;

  if (typeof msg === 'object') return next(); // batching
  if (msg instanceof ArrayBuffer) msg = Buffer.from(msg).toString();
  if (!msg) return ctx.throw(-32700);

  try {
    msg = JSON.parse(msg);
    ctx.msg = msg;
  } catch (error) {
    return ctx.throw(-32700);
  }

  return next();
};
