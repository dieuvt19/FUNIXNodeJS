'use strict';

const debug = require('debug')('pud:middleware:batching');
const compose = require('koa-compose');

module.exports = async function batching(ctx, next) {
  if (!Array.isArray(ctx.msg)) return next();
  if (!ctx.msg.length) return ctx.throw(-32600, 'Invalid array');

  debug('batching');

  const fn = compose(ctx.app.middleware);
  const arr = [];

  function fakesend(str) {
    arr.push(JSON.parse(str));
  }

  for (let msg of ctx.msg) {
    const _ctx = Object.create(ctx);
    _ctx.msg = msg;
    _ctx.send = fakesend;

    const onerror = err => _ctx.onerror(err);
    const onrespond = () => _ctx.respond();
    await fn(_ctx).then(onrespond).catch(onerror);
  }

  ctx.send(JSON.stringify(arr));
};
